<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#1C5CCF" media="(prefers-color-scheme: light)">
    <meta name="theme-color" content="#000000" media="(prefers-color-scheme: dark)">
    <title>Activity - Pesso</title>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="assets/img/favicon.png" sizes="32x32">    
    <link rel="apple-touch-icon" href="assets/icon/iconicon-192.png">
    <link rel="stylesheet" href="style.css">
    <style>
        /* Fix header to edge of notch */
        .header-large-title {
            padding-top: env(safe-area-inset-top) !important;
            padding-bottom: 8px;
        }
        
        /* ==================== SEARCH BOX ESTILO iOS ==================== */
        .search-form {
            margin: 16px 0;
        }
        
        .searchbox {
            position: relative;
            background: var(--bg-card);
            border-radius: 12px;
            overflow: hidden;
        }
        
        .searchbox input {
            width: 100%;
            padding: 12px 16px 12px 44px;
            border: none;
            background: transparent;
            font-size: 17px;
            color: var(--text);
            outline: none;
        }
        
        .searchbox input::placeholder {
            color: var(--text-secondary);
        }
        
        .input-icon {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* ==================== TABS ESTILO iOS ==================== */
        .nav-tabs {
            display: flex;
            gap: 8px;
            margin: 16px 0;
            padding: 4px;
            background: var(--bg-card);
            border-radius: 10px;
            list-style: none;
        }
        
        .nav-item {
            flex: 1;
        }
        
        .nav-link {
            display: block;
            padding: 10px 8px;
            text-align: center;
            text-decoration: none;
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 14px;
            border-radius: 8px;
            transition: all 0.2s;
            border: none;
            background: transparent;
            cursor: pointer;
        }
        
        .nav-link.active {
            color: var(--text);
            background: var(--bg);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        [data-theme="dark"] .nav-link.active {
            background: var(--bg-dark);
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        
        /* ==================== SECTION HEADER ==================== */
        .section-header-activity {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: 24px 0 16px 0;
            padding: 0 4px;
        }
        
        .section-title-activity {
            font-size: 20px;
            font-weight: 700;
            color: var(--text);
        }
        
        .clear-all-btn {
            font-size: 15px;
            color: var(--primary);
            background: none;
            border: none;
            font-weight: 600;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 8px;
        }
        
        .clear-all-btn:active {
            background: rgba(28, 92, 207, 0.1);
        }
        
        /* ==================== REMINDERS ==================== */
        .reminders-section {
            margin-top: 16px;
            margin-bottom: 24px;
        }
        
        .reminder-card {
            background: linear-gradient(135deg, var(--warning) 0%, #ff6b35 100%);
            border-radius: 16px;
            padding: 16px;
            color: white;
            margin-bottom: 12px;
            box-shadow: 0 4px 15px rgba(255, 149, 0, 0.3);
        }
        
        .reminder-card.danger {
            background: linear-gradient(135deg, var(--danger) 0%, #ff2d55 100%);
            box-shadow: 0 4px 15px rgba(255, 59, 48, 0.3);
        }
        
        .reminder-card.success {
            background: linear-gradient(135deg, var(--success) 0%, #30d158 100%);
            box-shadow: 0 4px 15px rgba(52, 199, 89, 0.3);
        }
        
        .reminder-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 15px;
        }
        
        .reminder-text {
            font-size: 14px;
            opacity: 0.95;
            line-height: 1.4;
        }
        
        .reminder-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }
        
        .reminder-btn {
            padding: 8px 16px;
            border-radius: 20px;
            border: none;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            background: rgba(255,255,255,0.25);
            color: white;
        }
        
        .reminder-btn:active {
            transform: scale(0.95);
            background: rgba(255,255,255,0.35);
        }
        
        /* ==================== TRANSACTIONS ==================== */
        .transactions-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .transaction-item {
            background: var(--bg-card);
            border-radius: 14px;
            padding: 14px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }
        
        .transaction-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            flex-shrink: 0;
            color: white;
        }
        
        .transaction-content {
            flex: 1;
        }
        
        .transaction-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }
        
        .transaction-title {
            font-weight: 600;
            font-size: 15px;
            color: var(--text);
        }
        
        .transaction-amount {
            font-weight: 700;
            font-size: 15px;
        }
        
        .transaction-amount.add {
            color: var(--success);
        }
        
        .transaction-amount.withdraw {
            color: var(--danger);
        }
        
        .transaction-amount.transfer {
            color: var(--info);
        }
        
        .transaction-desc {
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.4;
        }
        
        .transaction-time {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 4px;
        }
        
        /* ==================== EMPTY STATE ==================== */
        .empty-state-activity {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }
        
        .empty-state-activity ion-icon {
            font-size: 64px;
            margin-bottom: 16px;
            opacity: 0.3;
        }
        
        .empty-state-activity h3 {
            font-size: 18px;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 8px;
        }
        
        /* ==================== WIDE BLOCK ==================== */
        .wide-block {
            background: transparent;
            padding: 0;
        }
        
        .text-center {
            text-align: center;
        }
        
        .mt-3 {
            margin-top: 12px;
        }
    </style>
</head>

<body class="fade-in">

    <!-- App Capsule -->
    <div id="appCapsule" class="pfix">

        <div class="header-large-title">
            <h1 class="title">Activity</h1>
            <p class="subtitle" style="color: var(--text-secondary);">Your transactions & reminders</p>
        </div>

        <!-- Reminders Section -->
        <div class="reminders-section" id="remindersSection">
            <!-- Reminders loaded dynamically -->
        </div>

        <!-- Search -->
        <form class="search-form" onsubmit="return false;">
            <div class="searchbox">
                <span class="input-icon">
                    <ion-icon name="search-outline"></ion-icon>
                </span>
                <input type="text" class="form-control" placeholder="Search transactions" id="searchAlerts">
            </div>
        </form>

        <!-- Filters -->
        <div class="wide-block pt-2 pb-2">
            <ul class="nav-tabs" id="alertTabs">
                <li class="nav-item">
                    <a href="#" class="nav-link active" onclick="switchTab('all'); return false;">
                        All
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" onclick="switchTab('add'); return false;">
                        Added
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" onclick="switchTab('withdraw'); return false;">
                        Withdrawn
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" onclick="switchTab('transfer'); return false;">
                        Transfers
                    </a>
                </li>
            </ul>

            <!-- Transactions List -->
            <div class="section-header-activity" style="margin-top: 16px;">
                <span class="section-title-activity">History</span>
                <button class="clear-all-btn" onclick="clearAllNotifications()">Clear All</button>
            </div>
            
            <div id="transactionsList" class="transactions-container">
                <!-- Transacciones cargadas din√°micamente -->
            </div>
            
            <p class="text-center mt-3" style="color:var(--text-secondary); font-size:13px;">
                <span id="transactionCount">0 transactions</span>
            </p>
        </div>

    </div>

    <!-- Bottom Menu -->
    <div class="floating-menu-container">
        <nav class="floating-menu">
            <a href="index.html" class="menu-item" data-page="home">
                <ion-icon name="home-outline"></ion-icon>
                <strong>Home</strong>
                <div class="active-indicator"></div>
            </a>

            <a href="goals.html" class="menu-item" data-page="goals">
                <ion-icon name="flag-outline"></ion-icon>
                <strong>Goals</strong>
                <div class="active-indicator"></div>
            </a>

            <a href="alerts.html" class="menu-item active" data-page="activity">
                <ion-icon name="notifications-outline"></ion-icon>
                <strong>Activity</strong>
                <div class="active-indicator"></div>
            </a>

            <a href="profile.html" class="menu-item" data-page="me">
                <ion-icon name="person-outline"></ion-icon>
                <strong>Me</strong>
                <div class="active-indicator"></div>
            </a>
        </nav>
    </div>

    <!-- Toast -->
    <div id="toast" class="toast hidden"></div>

    <!-- Ionicons -->
    <script type="module" src="https://unpkg.com/ionicons@5.0.0/dist/ionicons/ionicons.js"></script>
    <script>
        // ==================== CONFIGURACI√ìN ====================
        const DB_NAME = 'PessoDB';
        const DB_VERSION = 4;
        
        let db = null;
        let currentTab = 'all';
        let allTransactions = [];

        // ==================== INICIALIZACI√ìN ====================
        document.addEventListener('DOMContentLoaded', () => {
            const isDarkMode = localStorage.getItem('pesso_dark_mode') === 'true';
            if (isDarkMode) {
                document.documentElement.setAttribute('data-theme', 'dark');
            }
            
            initAlerts();
        });

        async function initAlerts() {
            try {
                await initDB();
                await loadTransactions();
                await loadReminders();
                setupSearch();
            } catch (error) {
                console.error('Error inicializando alerts:', error);
            }
        }

        async function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                
                request.onerror = () => reject(request.error);
                
                request.onsuccess = () => {
                    db = request.result;
                    resolve(db);
                };
                
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    
                    if (!db.objectStoreNames.contains('envelopes')) {
                        db.createObjectStore('envelopes', { keyPath: 'id' });
                    }
                    if (!db.objectStoreNames.contains('goals')) {
                        db.createObjectStore('goals', { keyPath: 'id' });
                    }
                    if (!db.objectStoreNames.contains('notifications')) {
                        const notifStore = db.createObjectStore('notifications', { 
                            keyPath: 'id', 
                            autoIncrement: true 
                        });
                        notifStore.createIndex('date', 'date', { unique: false });
                    }
                };
            });
        }

        // ==================== REMINDERS ====================
        async function loadReminders() {
            const envelopes = await getAllFromStore('envelopes');
            const goals = await getAllFromStore('goals');
            const remindersContainer = document.getElementById('remindersSection');
            
            let remindersHTML = '';
            
            // Check for low balance envelopes
            envelopes.forEach(env => {
                if (env.goal && env.goal > 0) {
                    const percent = (env.amount / env.goal) * 100;
                    if (percent < 20 && env.amount < 50) {
                        remindersHTML += `
                            <div class="reminder-card danger">
                                <div class="reminder-header">
                                    <ion-icon name="warning-outline"></ion-icon>
                                    <span>Low Balance Alert</span>
                                </div>
                                <div class="reminder-text">
                                    "${env.name}" is at ${percent.toFixed(0)}% of goal ($${env.amount.toFixed(2)}). Consider adding funds.
                                </div>
                                <div class="reminder-actions">
                                    <button class="reminder-btn" onclick="location.href='index.html'">Add Cash</button>
                                </div>
                            </div>
                        `;
                    } else if (percent >= 100) {
                        remindersHTML += `
                            <div class="reminder-card success">
                                <div class="reminder-header">
                                    <ion-icon name="trophy-outline"></ion-icon>
                                    <span>Goal Reached! üéâ</span>
                                </div>
                                <div class="reminder-text">
                                    Congratulations! You've reached your goal for "${env.name}" ($${env.goal.toFixed(2)})
                                </div>
                            </div>
                        `;
                    }
                }
            });
            
            // Check for goals with approaching deadlines
            goals.forEach(goal => {
                if (goal.date) {
                    const daysLeft = Math.ceil((new Date(goal.date) - new Date()) / (1000 * 60 * 60 * 24));
                    const percent = (goal.saved / goal.target) * 100;
                    
                    if (daysLeft <= 7 && daysLeft > 0 && percent < 100) {
                        remindersHTML += `
                            <div class="reminder-card">
                                <div class="reminder-header">
                                    <ion-icon name="time-outline"></ion-icon>
                                    <span>Goal Deadline Approaching</span>
                                </div>
                                <div class="reminder-text">
                                    "${goal.name}" is due in ${daysLeft} days. You've saved ${percent.toFixed(0)}% of $${goal.target.toFixed(2)}
                                </div>
                                <div class="reminder-actions">
                                    <button class="reminder-btn" onclick="location.href='index.html'">Add Funds</button>
                                </div>
                            </div>
                        `;
                    }
                }
            });
            
            // Weekly summary
            const lastActivity = localStorage.getItem('pesso_last_activity');
            const daysSinceActivity = lastActivity ? 
                Math.floor((Date.now() - parseInt(lastActivity)) / (1000 * 60 * 60 * 24)) : 0;
            
            if (daysSinceActivity >= 7) {
                const totalSaved = envelopes.reduce((sum, e) => sum + e.amount, 0);
                remindersHTML += `
                    <div class="reminder-card" style="background: linear-gradient(135deg, var(--primary) 0%, var(--info) 100%);">
                        <div class="reminder-header">
                            <ion-icon name="calendar-outline"></ion-icon>
                            <span>Weekly Check-in</span>
                        </div>
                        <div class="reminder-text">
                            You have $${totalSaved.toFixed(2)} total saved. Review your progress and keep saving!
                        </div>
                        <div class="reminder-actions">
                            <button class="reminder-btn" onclick="location.href='goals.html'">View Goals</button>
                        </div>
                    </div>
                `;
            }
            
            if (remindersHTML) {
                remindersContainer.innerHTML = '<div class="section-title-activity" style="margin-bottom: 12px; padding-left: 4px;">Reminders</div>' + remindersHTML;
            } else {
                remindersContainer.style.display = 'none';
            }
        }

        // ==================== TRANSACTIONS ====================
        async function loadTransactions() {
            try {
                allTransactions = await getRecentTransactions(30);
                renderTransactions();
                updateCount();
            } catch (error) {
                console.error('Error cargando transacciones:', error);
            }
        }

        function renderTransactions() {
            const list = document.getElementById('transactionsList');
            if (!list) return;
            
            const filtered = currentTab === 'all' 
                ? allTransactions 
                : allTransactions.filter(t => t.type === currentTab);
            
            if (filtered.length === 0) {
                list.innerHTML = `
                    <div class="empty-state-activity">
                        <ion-icon name="receipt-outline"></ion-icon>
                        <h3>No transactions yet</h3>
                        <p>Your activity will appear here</p>
                    </div>
                `;
                return;
            }
            
            list.innerHTML = filtered.map(trx => {
                const date = new Date(trx.date);
                const timeStr = formatTimeAgo(date);
                const icon = getTransactionIcon(trx.type);
                const color = getTransactionColor(trx.type);
                const sign = trx.type === 'add' ? '+' : trx.type === 'withdraw' ? '-' : '‚Üî';
                const amount = trx.amount ? `$${trx.amount.toFixed(2)}` : '';
                
                return `
                    <div class="transaction-item" data-type="${trx.type}">
                        <div class="transaction-icon ${color}">
                            <ion-icon name="${icon}"></ion-icon>
                        </div>
                        <div class="transaction-content">
                            <div class="transaction-header">
                                <span class="transaction-title">${trx.title}</span>
                                <span class="transaction-amount ${trx.type}">${sign}${amount}</span>
                            </div>
                            <div class="transaction-desc">${trx.description}</div>
                            <div class="transaction-time">${timeStr}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateCount() {
            const countEl = document.getElementById('transactionCount');
            if (countEl) {
                countEl.textContent = `${allTransactions.length} transaction${allTransactions.length !== 1 ? 's' : ''}`;
            }
        }

        function getTransactionIcon(type) {
            const icons = {
                'add': 'arrow-down-outline',
                'withdraw': 'arrow-up-outline',
                'transfer': 'swap-horizontal-outline',
                'goal': 'trophy-outline',
                'goal_created': 'flag-outline'
            };
            return icons[type] || 'notifications-outline';
        }

        function getTransactionColor(type) {
            const colors = {
                'add': 'bg-success',
                'withdraw': 'bg-danger',
                'transfer': 'bg-info',
                'goal': 'bg-primary',
                'goal_created': 'bg-warning'
            };
            return colors[type] || 'bg-primary';
        }

        function formatTimeAgo(date) {
            const now = new Date();
            const diff = now - date;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);
            
            if (minutes < 1) return 'Just now';
            if (minutes < 60) return `${minutes}m ago`;
            if (hours < 24) return `${hours}h ago`;
            if (days < 7) return `${days}d ago`;
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        async function getRecentTransactions(days = 30) {
            return new Promise((resolve) => {
                if (!db) {
                    resolve([]);
                    return;
                }
                
                if (!db.objectStoreNames.contains('notifications')) {
                    resolve([]);
                    return;
                }
                
                try {
                    const tx = db.transaction('notifications', 'readonly');
                    const store = tx.objectStore('notifications');
                    const request = store.getAll();
                    
                    request.onsuccess = () => {
                        const allNotifications = request.result || [];
                        const cutoffDate = new Date();
                        cutoffDate.setDate(cutoffDate.getDate() - days);
                        
                        const filtered = allNotifications
                            .filter(n => new Date(n.date) >= cutoffDate)
                            .sort((a, b) => new Date(b.date) - new Date(a.date));
                        
                        resolve(filtered);
                    };
                    
                    request.onerror = () => resolve([]);
                } catch (error) {
                    resolve([]);
                }
            });
        }

        async function clearAllNotifications() {
            if (!db || !db.objectStoreNames.contains('notifications')) return;
            
            if (!confirm('Clear all transaction history?')) return;
            
            try {
                const tx = db.transaction('notifications', 'readwrite');
                const store = tx.objectStore('notifications');
                await store.clear();
                allTransactions = [];
                renderTransactions();
                updateCount();
                showToast('History cleared');
            } catch (error) {
                console.error('Error clearing notifications:', error);
            }
        }

        // ==================== TABS ====================
        function switchTab(tabName) {
            currentTab = tabName;
            
            document.querySelectorAll('.nav-link').forEach(tab => {
                tab.classList.remove('active');
            });
            
            const tabs = document.querySelectorAll('.nav-link');
            tabs.forEach(tab => {
                const text = tab.textContent.trim().toLowerCase();
                if ((tabName === 'all' && text === 'all') ||
                    (tabName === 'add' && text === 'added') ||
                    (tabName === 'withdraw' && text === 'withdrawn') ||
                    (tabName === 'transfer' && text === 'transfers')) {
                    tab.classList.add('active');
                }
            });
            
            renderTransactions();
        }

        // ==================== SEARCH ====================
        function setupSearch() {
            const searchInput = document.getElementById('searchAlerts');
            if (!searchInput) return;
            
            searchInput.addEventListener('input', (e) => {
                const term = e.target.value.toLowerCase();
                const items = document.querySelectorAll('.transaction-item');
                
                items.forEach(item => {
                    const text = item.textContent.toLowerCase();
                    item.style.display = text.includes(term) ? 'flex' : 'none';
                });
            });
        }

        // ==================== UTILIDADES ====================
        async function getAllFromStore(storeName) {
            return new Promise((resolve) => {
                if (!db) {
                    resolve([]);
                    return;
                }
                
                if (!db.objectStoreNames.contains(storeName)) {
                    resolve([]);
                    return;
                }
                
                try {
                    const tx = db.transaction(storeName, 'readonly');
                    const store = tx.objectStore(storeName);
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result || []);
                    request.onerror = () => resolve([]);
                } catch (error) {
                    resolve([]);
                }
            });
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            if (!toast) {
                alert(message);
                return;
            }
            
            toast.textContent = message;
            toast.classList.remove('hidden');
            
            setTimeout(() => {
                toast.classList.add('hidden');
            }, 3000);
        }

        // Menu ripple effect
        document.querySelectorAll('.menu-item').forEach(item => {
            item.addEventListener('click', function(e) {
                const ripple = document.createElement('span');
                ripple.classList.add('ripple');
                const rect = this.getBoundingClientRect();
                const size = Math.max(rect.width, rect.height);
                ripple.style.width = ripple.style.height = size + 'px';
                ripple.style.left = (rect.width/2 - size/2) + 'px';
                ripple.style.top = (rect.height/2 - size/2) + 'px';
                this.appendChild(ripple);
                setTimeout(() => ripple.remove(), 600);
            });
        });
    </script>

    <script>
        // Aplicar tema inmediatamente
        (function() {
            const isDarkMode = localStorage.getItem('pesso_dark_mode') === 'true';
            if (isDarkMode) {
                document.documentElement.setAttribute('data-theme', 'dark');
            }
        })();
    </script>
    
    <script>
        // Asegurar que el men√∫ siempre est√© visible
        document.addEventListener('DOMContentLoaded', function() {
            const menu = document.querySelector('.floating-menu-container');
            if (menu) {
                menu.style.display = 'block';
                menu.style.visibility = 'visible';
                menu.style.opacity = '1';
            }
        });
    </script>

    <script>
        // Registrar Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then((registration) => {
                        console.log('‚úÖ SW registrado:', registration.scope);
                    })
                    .catch((error) => {
                        console.error('‚ùå Error registrando SW:', error);
                    });
            });
        }
    </script>

</body>
</html>